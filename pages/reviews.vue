<template>
  <div id="reviews">
    <div class="reviews_top_section d-flex justify-space-between align-center container-padding container">
      <div class="reviews_top_section_header width-100 d-flex align-center">
        <div>
          <hr class="component-top-header-hr">
        </div>
        <div class="ml-4 white-text-shadow">
          <span>{{ $t('menuLinks.reviews') }} (В процессе)</span>
        </div>
      </div>
    </div>
    <div class="row margin-top-6vh container-padding container">
      <div class="col-lg-7 offset-lg-2 col-md-8 offset-md-2 text-center col-12 reviews_write_review_description">
        Lorem ipsum dolor sit amet, consectetur adipisicing elit. Blanditiis praesentium quibusdam tempore! Atque eum
        explicabo, fuga magni totam unde vero! A blanditiis consequuntur cumque cupiditate doloremque fugit
        perferendis repellat voluptates! Lorem ipsum dolor sit amet, consectetur adipisicing elit. Amet commodi eum ex
        mollitia placeat porro, quaerat! Ad, commodi dolore fugit, minima nemo nisi nostrum quam quod sit veniam vitae
        voluptatum.
      </div>
    </div>
    <div class="reviews_write_review inset-shadow-10 margin-top-6vh">
      <div class="row container-padding red-pattern-background inset-shadow-10">
        <div class="col-12 pt-5 px-0">
          <v-form
            ref="reviewForm"
            v-model="valid"
            lazy-validation>
            <div class="row">
              <div class="col-md-12 reviews_write_review_section text-center px-0">
                <span class="reviews_write_review_section_text black--text black-text-shadow">{{ $t('writeYourReview') }}</span>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 px-0">
                <Rating @passRate="reviewForm.rate = $event"></Rating>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 col-12 offset-md-2">
                <v-text-field
                  filled
                  :rules="nameRules"
                  counter="50"
                  name="name"
                  dark
                  color="white"
                  v-model="reviewForm.name"
                  :label="$t('name')"
                  required>
                </v-text-field>
              </div>
              <div class="col-md-4 col-12">
                <v-text-field
                  filled
                  :rules="emailRules"
                  counter="50"
                  name="email"
                  v-model="reviewForm.email"
                  :label="$t('emailAddress')"
                  dark
                  color="white"
                  required>
                </v-text-field>
              </div>
            </div>
            <div class="row">
              <div class="col-md-8 offset-md-2">
                <v-textarea
                  filled
                  :rules="textRules"
                  :counter="1000"
                  name="text"
                  v-model="reviewForm.text"
                  :label="$t('yourOpinion')"
                  dark
                  color="white"
                  required>
                </v-textarea>
              </div>
            </div>
            <div class="row mb-4">
              <div class="col-md-12 px-0 text-center">
                <v-btn
                  class="font-weight-bold"
                  @click="sendReview"
                  large
                  rounded
                  light>
                  {{ $t('sendReview') }}
                </v-btn>
              </div>
            </div>
          </v-form>
        </div>
      </div>
      <div class="reviews_all_testimonials margin-top-6vh container-padding">
        <div class="row">
          <div v-infinite-scroll="loadMore" infinite-scroll-disabled="busy" infinite-scroll-distance="5" class="width-100">
            <div class="col-md-8 col-lg-7 col-12 offset-md-2 offset-lg-2 mb-5"
                 v-for="(review, index) in $store.getters['reviews/data'].reviews" :key="index">
              <v-card
                light
                class="white-pattern-background"
                elevation="12">
                <div class="row">
                  <div class="col-md-2 reviews_all_testimonials_card_customer-avatar offset-cart-left-2">
                    <v-avatar width="70%" height="auto">
                      <v-img
                        :src="require('~/assets/icons/user.png')"
                        :lazy-src="require('~/assets/icons/user.png')">
                      </v-img>
                    </v-avatar>
                  </div>
                  <div class="col-md-9">
                    <div class="row">
                      <div class="col-md-12 reviews_all_testimonials_card_customer-name">
                        <span>{{ review.name }}</span>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-12 reviews_all_testimonials_card_review pt-0">
                        <span>{{ review.text }}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row justify-space-around">
                  <div class="col ml-5">
                    <StaticRating :rateValue="review.rate"></StaticRating>
                  </div>
                  <div class="col text-right mr-5">
                    {{ review.created_at }}
                  </div>
                </div>
              </v-card>
            </div>
            <div class="text-center">
              <pulse-loader :loading="busy" color="#202020" size="20px"></pulse-loader>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import Rating from '~/components/Rating'
import StaticRating from '~/components/StaticRating'
import PulseLoader from 'vue-spinner/src/PulseLoader.vue'
import Swal from "sweetalert2";

export default {
  name: "reviews",
  components: {
    Rating,
    StaticRating,
    PulseLoader,
  },
  async asyncData({store}) {
    const cursor = 1;
    await store.dispatch('reviews/getData', {
      cursor
    });

    return {cursor}
  },
  data() {
    return {
      valid: false,
      busy: false,
      reviewForm: {
        name: '',
        email: '',
        text: '',
        rate: 5,
      },
      nameRules: [
        v => !!v || this.$t('validationText.fieldRequired', {fieldName: this.$t('name')}),
        v => (v && v.length > 3) || this.$t('validationText.moreOrLessThenCharacters', {
          fieldName: this.$t('name'),
          moreOrLess: this.$t('more'),
          qty: '4',
        }),
        v => (v && v.length <= 50) || this.$t('validationText.moreOrLessThenCharacters', {
          fieldName: this.$t('name'),
          moreOrLess: this.$t('less'),
          qty: '50',
        }),
      ],
      textRules: [
        v => !!v || this.$t('validationText.fieldRequired', {fieldName: this.$t('message')}),
        v => (v && v.length > 3) || this.$t('validationText.moreOrLessThenCharacters', {
          fieldName: this.$t('message'),
          moreOrLess: this.$t('more'),
          qty: '4',
        }),
        v => (v && v.length <= 1000) || this.$t('validationText.moreOrLessThenCharacters', {
          fieldName: this.$t('message'),
          moreOrLess: this.$t('less'),
          qty: '1000',
        }),
      ],
      emailRules: [
        v => !!v || this.$t('validationText.fieldRequired', {fieldName: this.$t('emailAddress')}),
        v => /.+@.+/.test(v) || this.$t('validationText.mustBeValid', {fieldName: this.$t('emailAddress')}),
      ],
    }
  },
  methods: {
    async sendReview() {
      if (this.$refs.reviewForm.validate()) {
        await this.$store.dispatch('reviews/store', this.reviewForm).then(response => {
          this.$refs.reviewForm.reset();
          Swal.fire({
            position: 'center',
            icon: 'success',
            title: this.$t('reviewSuccess'),
            showConfirmButton: false,
            timer: 5000
          });
        });
      }
    },
    loadMore() {
      if (this.$store.getters['reviews/data'].reviews.length < this.$store.getters['reviews/data'].allCount) {
        this.cursor++;
        this.busy = true;
        setTimeout(() => {
          this.$store.dispatch('reviews/getData', {
            cursor: this.cursor
          })
          this.busy = false;
        }, 1000);
      }
    }
  }
}
</script>

<style scoped>
#reviews {
  margin-top: 18vh;
}

.reviews_top_section_header {
  font-size: 70px;
}

.reviews_write_review_description {
  font-size: 21px;
}

.reviews_write_review_section_text {
  font-size: 51px;
}

.reviews_all_testimonials_card_customer-name {
  font-size: 40px;
}

.reviews_all_testimonials_card_review {
  font-size: 16px;
}

.reviews_write_review {
  padding-bottom: 6vh;
}
</style>
